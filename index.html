<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AIRSMET â€“ Airspace Situational Awareness</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0b1220;
  color: #fff;
}
#sidebar {
  position: absolute;
  left: 0;
  top: 0;
  width: 260px;
  height: 100%;
  background: #0e1628;
  padding: 15px;
  z-index: 1000;
}
#map {
  position: absolute;
  left: 260px;
  top: 0;
  right: 0;
  bottom: 0;
}
h2 {
  margin-top: 0;
}
label {
  display: block;
  margin: 6px 0;
}
.status {
  font-size: 12px;
  opacity: 0.85;
  margin-top: 10px;
}
</style>
</head>

<body>

<div id="sidebar">
  <h2>AIRSMET</h2>

  <strong>Map View</strong>
  <label><input type="radio" name="basemap" checked onclick="setBase('standard')"> Standard</label>
  <label><input type="radio" name="basemap" onclick="setBase('dark')"> Dark</label>
  <label><input type="radio" name="basemap" onclick="setBase('sat')"> Satellite</label>

  <hr>

  <strong>Layers</strong>
  <label><input type="checkbox" checked onchange="toggleLayer(aircraftLayer)"> ADS-B Aircraft</label>
  <label><input type="checkbox" checked onchange="toggleLayer(trailLayer)"> Aircraft Trails</label>
  <label><input type="checkbox" checked onchange="toggleLayer(tfrLayer)"> TFRs</label>
  <label><input type="checkbox" checked onchange="toggleLayer(notamLayer)"> NOTAMs</label>

  <div class="status">
    Region: Southern California<br>
    Mode: Demo<br>
    Data: OpenSky + FAA
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ================= MAP BASES =================
const baseStandard = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
const baseDark = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png");
const baseSat = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");

const map = L.map("map", {
  center: [34.3, -119.2],
  zoom: 9,
  layers: [baseStandard]
});

function setBase(type) {
  map.eachLayer(l => {
    if (l === baseStandard || l === baseDark || l === baseSat) {
      map.removeLayer(l);
    }
  });
  if (type === "standard") baseStandard.addTo(map);
  if (type === "dark") baseDark.addTo(map);
  if (type === "sat") baseSat.addTo(map);
}

function toggleLayer(layer) {
  if (map.hasLayer(layer)) map.removeLayer(layer);
  else map.addLayer(layer);
}

// ================= LAYERS =================
const aircraftLayer = L.layerGroup().addTo(map);
const trailLayer = L.layerGroup().addTo(map);
const tfrLayer = L.layerGroup().addTo(map);
const notamLayer = L.layerGroup().addTo(map);

// ================= AIRCRAFT + TRAILS =================
const aircraftTracks = {};

async function loadAircraft() {
  const url = "https://opensky-network.org/api/states/all?lamin=33.5&lomin=-121&lamax=35&lomax=-117";
  const res = await fetch(url);
  const data = await res.json();

  aircraftLayer.clearLayers();
  trailLayer.clearLayers();

  if (!data.states) return;

  data.states.forEach(s => {
    const icao = s[0];
    const lat = s[6];
    const lon = s[5];

    if (!lat || !lon) return;

    if (!aircraftTracks[icao]) aircraftTracks[icao] = [];
    aircraftTracks[icao].push([lat, lon]);

    if (aircraftTracks[icao].length > 12)
      aircraftTracks[icao].shift();

    L.circleMarker([lat, lon], {
      radius: 4,
      color: "#00d0ff"
    }).addTo(aircraftLayer)
      .bindPopup(`ICAO: ${icao}`);

    L.polyline(aircraftTracks[icao], {
      color: "#00d0ff",
      weight: 1,
      opacity: 0.6
    }).addTo(trailLayer);
  });
}

setInterval(loadAircraft, 8000);
loadAircraft();

// ================= TFRs =================
fetch("https://tfr.faa.gov/tfr_map_ims_data.json")
  .then(r => r.json())
  .then(data => {
    data.features.forEach(f => {
      const coords = f.geometry.coordinates[0].map(c => [c[1], c[0]]);
      L.polygon(coords, {
        color: "red",
        fillOpacity: 0.2
      }).addTo(tfrLayer)
        .bindPopup("FAA Temporary Flight Restriction");
    });
  });

// ================= NOTAMS (DEMO STRUCTURE) =================
const demoNotams = [
  {
    name: "Disneyland Stadium TFR",
    lat: 33.8121,
    lon: -117.9190,
    radius: 5560
  }
];

demoNotams.forEach(n => {
  L.circle([n.lat, n.lon], {
    radius: n.radius,
    color: "orange",
    fillOpacity: 0.15
  }).addTo(notamLayer)
    .bindPopup(n.name);
});
</script>

</body>
</html>
