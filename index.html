<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AIRSMET – Airspace Situational Awareness</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #0b1320;
  color: #e6eefc;
  font-family: Arial, sans-serif;
}

#container {
  display: flex;
  height: 100%;
}

#sidebar {
  width: 300px;
  background: #0f1a2b;
  padding: 12px;
  box-sizing: border-box;
  overflow-y: auto;
  transition: transform 0.3s ease;
}

#sidebar.hidden {
  transform: translateX(-100%);
}

#map {
  flex: 1;
}

#toggleSidebar {
  display: none;
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background: #1b2a44;
  color: #fff;
  padding: 8px 10px;
  border-radius: 4px;
  cursor: pointer;
}

h2 { margin-top: 0; }

.section { margin-bottom: 14px; }
label { display: block; margin-bottom: 6px; font-size: 14px; }

.violation {
  background:#1b2a44;
  border-left:4px solid #ff4444;
  padding:6px;
  margin-bottom:6px;
  font-size:13px;
  cursor:pointer;
}

.violation:hover { background:#24365c; }

.small { font-size:12px; color:#9fb4d9; }

/* Mobile */
@media (max-width: 768px) {
  #sidebar {
    position: absolute;
    height: 100%;
    z-index: 999;
  }
  #toggleSidebar {
    display: block;
  }
}
</style>
</head>

<body>

<div id="toggleSidebar" onclick="toggleSidebar()">☰</div>

<div id="container">
  <div id="sidebar">
    <h2>AIRSMET</h2>

    <div class="section">
      <strong>Map View</strong>
      <label><input type="radio" name="basemap" checked onclick="setBase('standard')"> Standard</label>
      <label><input type="radio" name="basemap" onclick="setBase('dark')"> Dark</label>
      <label><input type="radio" name="basemap" onclick="setBase('sat')"> Satellite</label>
    </div>

    <div class="section">
      <strong>Layers</strong>
      <label><input type="checkbox" checked onclick="toggleLayer(aircraftLayer)"> Aircraft</label>
      <label><input type="checkbox" checked onclick="toggleLayer(tfrLayer)"> FAA TFRs</label>
      <label><input type="checkbox" checked onclick="toggleLayer(advisoryLayer)"> Advisory Zones</label>
    </div>

    <div class="section">
      <strong>Alerts</strong>
      <label><input type="checkbox" id="soundToggle" checked> Audible Alert</label>
    </div>

    <div class="section">
      <strong>Restricted Airspace Activity</strong>
      <div id="violationList" class="small">No active violations</div>
    </div>

    <div class="section small">
      Region: CA (SLO → NV → MX)<br>
      Aircraft: OpenSky (Live)<br>
      Classification: Estimated<br>
      Advisory: Informational
    </div>
  </div>

  <div id="map"></div>
</div>

<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map("map").setView([34.1, -118.8], 7);

// ===== BASEMAPS =====
const baseStandard = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const baseDark = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png");
const baseSat = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");

function setBase(type){
  [baseStandard, baseDark, baseSat].forEach(b => map.removeLayer(b));
  if(type==="standard") baseStandard.addTo(map);
  if(type==="dark") baseDark.addTo(map);
  if(type==="sat") baseSat.addTo(map);
}

// ===== LAYERS =====
const aircraftLayer = L.layerGroup().addTo(map);
const tfrLayer = L.layerGroup().addTo(map);
const advisoryLayer = L.layerGroup().addTo(map);

// ===== STATE =====
const aircraftState = {};
const violations = {};

// ===== ADVISORY ZONES =====
const advisoryZones = [
  { name:"Disneyland", lat:33.8121, lon:-117.9190, radius:5560 },
  { name:"Dodger Stadium", lat:34.0739, lon:-118.2400, radius:5560 },
  { name:"SoFi Stadium", lat:33.9535, lon:-118.3390, radius:5560 }
];

advisoryZones.forEach(z => {
  L.circle([z.lat,z.lon],{
    radius:z.radius,
    color:"#ff9800",
    dashArray:"6,6",
    fillOpacity:0.1
  }).bindPopup(`<strong>${z.name}</strong><br>Advisory – NOTAM pending`)
    .addTo(advisoryLayer);
});

// ===== FAA TFRs =====
fetch("https://tfr.faa.gov/tfrapi/geojson")
.then(r=>r.json())
.then(data=>{
  L.geoJSON(data,{
    style:{color:"#ff4444",weight:2,fillOpacity:0.15},
    onEachFeature:(f,l)=>l.bindPopup("FAA Temporary Flight Restriction")
  }).addTo(tfrLayer);
});

// ===== HELPERS =====
function classifyAircraft(speedKmh, altitudeM){
  if(speedKmh && speedKmh < 150 && altitudeM && altitudeM < 3000){
    return "Helicopter (est.)";
  }
  return "Fixed-wing (est.)";
}

function playAlert(){
  if(document.getElementById("soundToggle").checked){
    document.getElementById("alertSound").play();
  }
}

// ===== AIRCRAFT =====
async function loadAircraft(){
  aircraftLayer.clearLayers();
  const res = await fetch(
    "https://opensky-network.org/api/states/all?lamin=32&lamax=35.7&lomin=-121.5&lomax=-114"
  );
  const data = await res.json();
  if(!data.states) return;

  data.states.forEach(s=>{
    const icao=s[0], callsign=s[1]?.trim()||"N/A";
    const lon=s[5], lat=s[6], alt=s[7], vel=s[9], hdg=s[10];
    if(!lat||!lon) return;

    if(!aircraftState[icao]) aircraftState[icao]={ history:[] };
    aircraftState[icao].history.push([lat,lon]);
    if(aircraftState[icao].history.length>6) aircraftState[icao].history.shift();

    let violatedZone=null;
    advisoryZones.forEach(z=>{
      if(map.distance([lat,lon],[z.lat,z.lon])<z.radius){
        violatedZone=z.name;
      }
    });

    const speedKmh = vel ? vel*3.6 : null;
    const type = classifyAircraft(speedKmh, alt);
    const color=violatedZone?"#ff3333":"#00e5ff";

    L.polyline(aircraftState[icao].history,{color,weight:2,opacity:0.6})
      .addTo(aircraftLayer);

    L.circleMarker([lat,lon],{radius:5,color})
      .addTo(aircraftLayer)
      .bindPopup(`
        <strong>${type}</strong><br>
        ICAO: ${icao}<br>
        Callsign: ${callsign}<br>
        Altitude: ${alt?Math.round(alt)+" m":"N/A"}<br>
        Speed: ${speedKmh?Math.round(speedKmh)+" km/h":"N/A"}<br>
        Heading: ${hdg?Math.round(hdg)+"°":"N/A"}
      `);

    if(violatedZone && !violations[icao]){
      violations[icao]={icao,callsign,zone:violatedZone,lat,lon,type};
      playAlert();
      updateViolationList();
    }
  });
}

function updateViolationList(){
  const box=document.getElementById("violationList");
  box.innerHTML="";
  Object.values(violations).forEach(v=>{
    const d=document.createElement("div");
    d.className="violation";
    d.innerHTML=`<strong>${v.callsign}</strong><br>${v.type}<br>Zone: ${v.zone}`;
    d.onclick=()=>map.setView([v.lat,v.lon],12);
    box.appendChild(d);
  });
  if(!box.innerHTML) box.innerHTML="No active violations";
}

loadAircraft();
setInterval(loadAircraft,10000);

function toggleLayer(layer){
  map.hasLayer(layer)?map.removeLayer(layer):map.addLayer(layer);
}

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("hidden");
}
</script>
</body>
</html>
