<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AIRSMET â€“ Airspace Situational Awareness</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #0b1320;
  color: #e6eefc;
  font-family: Arial, sans-serif;
}

#container {
  display: flex;
  height: 100%;
}

#sidebar {
  width: 260px;
  background: #0f1a2b;
  padding: 15px;
  box-sizing: border-box;
}

#map {
  flex: 1;
}

h2 {
  margin-top: 0;
  font-size: 18px;
}

.section {
  margin-bottom: 15px;
}

label {
  display: block;
  margin-bottom: 6px;
}

.status {
  font-size: 12px;
  color: #9fb4d9;
}
</style>
</head>

<body>
<div id="container">
  <div id="sidebar">
    <h2>AIRSMET</h2>
    <div class="section">
      <strong>Map View</strong>
      <label><input type="radio" name="basemap" checked onclick="setBase('standard')"> Standard</label>
      <label><input type="radio" name="basemap" onclick="setBase('dark')"> Dark</label>
      <label><input type="radio" name="basemap" onclick="setBase('sat')"> Satellite</label>
    </div>

    <div class="section">
      <strong>Layers</strong>
      <label><input type="checkbox" checked onclick="toggleLayer(aircraftLayer)"> ADS-B Aircraft</label>
      <label><input type="checkbox" checked onclick="toggleLayer(tfrLayer)"> TFRs (FAA)</label>
      <label><input type="checkbox" checked onclick="toggleLayer(regionLayer)"> Region Boundary</label>
      <label><input type="checkbox" onclick="toggleLayer(notamLayer)"> NOTAMs (Pending)</label>
    </div>

    <div class="section status">
      Region: CA / SoCal Expanded<br>
      Aircraft: OpenSky (Live)<br>
      TFRs: FAA GeoJSON (Live)<br>
      NOTAMs: FAA API (Pending)
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map("map").setView([34.2, -118.8], 7);

// --- BASEMAPS ---
const baseStandard = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { maxZoom: 18 }
).addTo(map);

const baseDark = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { maxZoom: 18 }
);

const baseSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 18 }
);

function setBase(type) {
  map.eachLayer(l => {
    if (l === baseStandard || l === baseDark || l === baseSat) {
      map.removeLayer(l);
    }
  });
  if (type === "standard") baseStandard.addTo(map);
  if (type === "dark") baseDark.addTo(map);
  if (type === "sat") baseSat.addTo(map);
}

// --- REGION BOUNDARY ---
const regionLayer = L.rectangle(
  [[32.0, -121.5], [35.7, -114.0]],
  { color: "red", weight: 1, fillOpacity: 0.05 }
).addTo(map);

// --- AIRCRAFT ---
const aircraftLayer = L.layerGroup().addTo(map);
const aircraftHistory = {};

async function loadAircraft() {
  aircraftLayer.clearLayers();

  const url =
    "https://opensky-network.org/api/states/all?" +
    "lamin=32.0&lamax=35.7&lomin=-121.5&lomax=-114.0";

  const res = await fetch(url);
  const data = await res.json();
  if (!data.states) return;

  data.states.forEach(s => {
    const icao = s[0];
    const callsign = s[1]?.trim() || "Unknown";
    const lon = s[5];
    const lat = s[6];
    if (!lat || !lon) return;

    if (!aircraftHistory[icao]) aircraftHistory[icao] = [];
    aircraftHistory[icao].push([lat, lon]);
    if (aircraftHistory[icao].length > 15) aircraftHistory[icao].shift();

    L.polyline(aircraftHistory[icao], {
      color: "#00ffff",
      weight: 1
    }).addTo(aircraftLayer);

    L.circleMarker([lat, lon], {
      radius: 4,
      color: "#00ffff"
    }).addTo(aircraftLayer)
      .bindPopup(`
        <strong>Aircraft</strong><br>
        ICAO: ${icao}<br>
        Callsign: ${callsign}
      `);
  });
}

loadAircraft();
setInterval(loadAircraft, 10000);

// --- TFRs (FAA LIVE) ---
const tfrLayer = L.layerGroup().addTo(map);

fetch("https://tfr.faa.gov/tfrapi/geojson")
  .then(res => res.json())
  .then(data => {
    L.geoJSON(data, {
      style: {
        color: "#ff4444",
        weight: 2,
        fillOpacity: 0.15
      },
      onEachFeature: (f, l) => {
        l.bindPopup(`
          <strong>TFR</strong><br>
          ${f.properties?.description || "FAA Temporary Flight Restriction"}
        `);
      }
    }).addTo(tfrLayer);
  });

// --- NOTAM PLACEHOLDER ---
const notamLayer = L.layerGroup();
L.marker([33.8121, -117.9190], { opacity: 0.7 })
  .bindPopup("NOTAM data pending FAA API approval")
  .addTo(notamLayer);

// --- TOGGLE ---
function toggleLayer(layer) {
  map.hasLayer(layer) ? map.removeLayer(layer) : map.addLayer(layer);
}
</script>
</body>
</html>
